# アスパラガス セグメンテーション カメラアプリ

YOLO11seg-smallモデルを使用したリアルタイムセグメンテーションアプリです。

## 機能

### カメラ機能
- **リアルタイムカメラ入力**
- **ピンチズーム** - ピンチジェスチャーでカメラをズーム（最大10倍）、倍率を画面に表示
- **写真撮影** - セグメンテーションマスク+検出ラベル付きで撮影・保存
- **動画撮影** - セグメンテーションマスク+検出ラベルを合成した動画を録画・保存
- **デバイス回転対応** - カメラプレビューとセグメンテーションオーバーレイが回転に追従

### 検出機能
- **6クラスのセグメンテーション検出**:
  - 0: 親茎
  - 1: アスパラガス
  - 2: 枝
  - 3: 褐斑病
  - 4: 茎枯病
  - 5: 斑点病
- **NMS (Non-Maximum Suppression)** - IoU閾値0.5で重複検出を除去
- **病害虫オーバーラップフィルタ** - 病害虫は植物体（親茎/アスパラガス/枝）と20%以上重なっているもののみ表示

### 表示機能
- **カラーコード化されたセグメンテーションマスクオーバーレイ**
- **検出ラベル** - クラス名と信頼度を表示
- **詳細情報の表示機能** - 検出エリアをタップすると詳細情報を表示

### 設定
- **信頼度閾値** - スライダーで0.1〜0.9の範囲で調整可能
- **病害虫オーバーラップフィルタ** - ON/OFF切替可能
- **モデル情報** - 読み込みステータスの確認

## セットアップ

### 1. 権限の設定

Xcodeプロジェクトの `Info.plist` に以下のキーを追加:

```xml
<key>NSCameraUsageDescription</key>
<string>アスパラガスの病気検出のためにカメラを使用します</string>

<key>NSPhotoLibraryAddUsageDescription</key>
<string>撮影した写真や動画を保存するためにフォトライブラリへのアクセスが必要です</string>

<key>NSPhotoLibraryUsageDescription</key>
<string>撮影した写真や動画を表示するためにフォトライブラリへのアクセスが必要です</string>
```

### 2. YOLOモデルの追加

1. YOLO11seg-smallモデルを Core ML形式 (.mlpackage) に変換
2. 変換したモデルをXcodeプロジェクトに追加
3. モデルは起動時に非同期で読み込まれ、ローディングインジケーターが表示されます

### YOLOモデルの変換 (Python)

```python
from ultralytics import YOLO

# YOLOモデルの読み込み
model = YOLO('yolo11seg-small.pt')

# Core ML形式にエクスポート
model.export(format='coreml')
```

## 使用方法

### 基本操作

1. アプリを起動（モデル読み込み中はインジケーターが表示されます）
2. カメラ権限を許可
3. カメラをアスパラガスに向ける
4. リアルタイムでセグメンテーション結果が表示されます

### ズーム

5. 画面をピンチイン/アウトでカメラをズーム
6. ズーム中は倍率が画面に表示されます

### 撮影機能

7. **写真撮影** - 画面下部中央の白いボタンをタップ
8. **動画撮影** - 画面下部右の赤いボタンをタップで録画開始/停止

写真・動画ともにセグメンテーションマスクと検出ラベルが合成された状態で保存されます。

### UI配置

- **右上**: 設定ボタン
- **左上**: 録画インジケーター（録画中のみ）
- **中央**: カメラビュー + セグメンテーションオーバーレイ
- **下部中央**: 写真撮影ボタン
- **下部右**: 動画撮影ボタン

## アーキテクチャ

- **CameraManager**: カメラセッション、フレームキャプチャ、写真・動画撮影、ズーム制御、フレーム合成
- **YOLOSegmentationModel**: YOLO推論、NMS、病害虫フィルタ、パフォーマンス計測
- **CameraView**: メインのUIビュー、設定画面
- **SegmentationOverlayView**: 検出結果のオーバーレイ表示
- **CameraPreviewView**: カメラプレビューのUIKit統合（回転対応）
- **CaptureControlsView**: 写真・動画撮影コントロール

## 技術詳細

### モデル出力
- `p` [1, 32, 160, 160]: マスクプロトタイプ
- `var_1369` [1, 42, 8400]: 検出結果（4 bbox + 6 classes + 32 mask coefficients）

### 録画方式
- AVAssetWriterベースで、各フレームにマスクとラベルをCGContextで合成

### オーバーレイ描画
- AspectFillスケール計算でカメラプレビューとセグメンテーションオーバーレイの位置を正確に一致させる

## 必要な環境

- iOS 17.0以降
- Xcode 15以降
- カメラ搭載のiOSデバイス（シミュレータでは動作しません）
